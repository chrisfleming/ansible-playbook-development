---
- name: oh-my-zsh| clone repository
  ansible.builtin.git:
    repo: https://github.com/robbyrussell/oh-my-zsh
    dest: ~/.oh-my-zsh
    depth: 1
    version: master
  register: ohmyzsh_clone

- name: asdf| install via homebrew (macOS)
  community.general.homebrew:
    name: ["asdf"]
    state: present
    update_homebrew: true
  when: ansible_facts['distribution'] == 'MacOSX'

- name: asdf| install (Linux)
  ansible.builtin.import_tasks: asdf.yml
  when: ansible_facts['distribution'] != 'MacOSX'

- name: node| install via asdf
  ansible.builtin.import_tasks: node.yml
- name: pip| upgrade to latest
  ansible.builtin.pip:
    name: pip
    state: latest # noqa package-latest
    virtualenv: ~/.venv/system/
    virtualenv_command: "{{ ansible_facts.python.executable }} -m venv"

- name: hatch| install
  ansible.builtin.pip:
    name: hatch
    state: latest
    virtualenv: ~/.venv/system/
    virtualenv_command: "{{ ansible_facts.python.executable }} -m venv"

- name: bin| ensure ~/bin directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts.env.HOME }}/bin/"
    state: directory

- name: hatch| symlink into ~/bin
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.venv/system/bin/hatch"
    dest: "{{ ansible_facts.env.HOME }}/bin/hatch"
    state: link

- name: ntfy| install
  ansible.builtin.pip:
    name: ntfy
    state: latest
    virtualenv: ~/.venv/system/
    virtualenv_command: "{{ ansible_facts.python.executable }} -m venv"

- name: ntfy| configure
  ansible.builtin.template:
    src: ntfy.yml
    dest: ~/.ntfy.yml

- name: ntfy| symlink into ~/bin
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.venv/system/bin/ntfy"
    dest: "{{ ansible_facts.env.HOME }}/bin/ntfy"
    state: link

- name: pushbullet| install requests dependency
  ansible.builtin.pip:
    name: requests
    state: latest
    virtualenv: ~/.venv/system/
    virtualenv_command: "{{ ansible_facts.python.executable }} -m venv"

- name: pushbullet| clone repository
  ansible.builtin.git:
    repo: https://github.com/jchonig/pushbullet.git
    dest: ~/src/pushbullet/

- name: pushbullet| ensure ~/bin directory exists
  ansible.builtin.file:
    path: ~/bin
    state: directory

- name: pushbullet| check if script exists in ~/bin
  ansible.builtin.stat:
    path: ~/bin/pushbullet
  register: pushbullet_bin

- name: pushbullet| copy script to ~/bin
  ansible.builtin.copy:
    src: ~/src/pushbullet/pushbullet
    dest: ~/bin/pushbullet
    mode: "0700"
  when: not pushbullet_bin.stat.exists

- name: pushbullet| set shebang to venv python
  ansible.builtin.lineinfile:
    path: ~/bin/pushbullet
    regex: "^#!"
    line: "#!{{ ansible_facts.env.HOME }}/.venv/system/bin/python"
  when: not pushbullet_bin.stat.exists

- name: pushbullet| configure credentials in .netrc
  ansible.builtin.lineinfile:
    path: ~/.netrc
    regexp: "^machine pushbullet\\.com"
    create: true
    line: "machine pushbullet.com login {{ pushbullet_user }} password {{ pushbullet_api_token }}"
    mode: "0600"

- name: black| install
  ansible.builtin.pip:
    name: black
    state: latest
    virtualenv: ~/.venv/system/
    virtualenv_command: "{{ ansible_facts.python.executable }} -m venv"

- name: black| symlink into ~/bin
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.venv/system/bin/black"
    dest: "{{ ansible_facts.env.HOME }}/bin/black"
    state: link

- name: tmuxp| install
  ansible.builtin.pip:
    name: tmuxp
    state: latest
    virtualenv: ~/.venv/system/
    virtualenv_command: "{{ ansible_facts.python.executable }} -m venv"

- name: tmuxp| symlink into ~/bin
  ansible.builtin.file:
    src: "{{ ansible_facts.env.HOME }}/.venv/system/bin/tmuxp"
    dest: "{{ ansible_facts.env.HOME }}/bin/tmuxp"
    state: link

- name: dircolors-solarized| clone repository
  ansible.builtin.git:
    repo: https://github.com/seebi/dircolors-solarized.git
    dest: ~/src/dircolors-solarized/

- name: my-enviroment| clone repository
  ansible.builtin.git:
    repo: git@github.com:chrisfleming/my-enviroment.git
    version: master
    dest: $HOME/projects/my-enviroment
    accept_hostkey: false
    recursive: false
  register: enviromentclone

- name: my-enviroment| run setup_links.sh
  ansible.builtin.command: $HOME/projects/my-enviroment/bin/setup_links.sh
  changed_when: true
  when: enviromentclone.changed

- name: oh-my-zsh| fix directory permissions
  ansible.builtin.file:
    path: $HOME/.oh-my-zsh
    mode: "g-w,o-w"
    recurse: true
  when: ohmyzsh_clone.changed

- name: my-enviroment| fix zsh custom directory permissions
  ansible.builtin.file:
    path: $HOME/projects/my-enviroment/zsh/custom/
    mode: "g-w,o-w"
    recurse: true

- name: tmux| install plugins
  ansible.builtin.git:
    repo: https://github.com/tmux-plugins/tpm
    dest: $HOME/.tmux/plugins/tpm

- name: tmux plugins
  ansible.builtin.command: ~/.tmux/plugins/tpm/bin/install_plugins
  register: tpm_result
  changed_when: "'Installing' in tpm_result.stdout"
